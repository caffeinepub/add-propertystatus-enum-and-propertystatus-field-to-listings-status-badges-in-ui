{
  "kind": "build_request",
  "title": "Implement PropertyStatus transition state machine with 24h underConfirmation timeout",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Add backend-only PropertyStatus transition logic for listings with exactly these allowed transitions: #available → #visitCompleted, #visitCompleted → #underConfirmation, #underConfirmation → #bookedViaSTYO. Any other transition attempt must be rejected with an English error message.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Implement only the propertyStatus transition logic.\n\nRules:\n- #available → #visitCompleted\n- #visitCompleted → #underConfirmation\n- #underConfirmation → #bookedViaSTYO"
        ]
      },
      "acceptanceCriteria": [
        "A shared backend method exists to request a propertyStatus transition for a specific listing id.",
        "When current status is #available, transitioning to #visitCompleted succeeds; transitioning to any other status fails.",
        "When current status is #visitCompleted, transitioning to #underConfirmation succeeds; transitioning to any other status fails.",
        "When current status is #underConfirmation, transitioning to #bookedViaSTYO succeeds; transitioning to any other status fails.",
        "When current status is #bookedViaSTYO, all further transitions are rejected.",
        "Rejected transitions trap/return an English error message that clearly indicates the transition is invalid."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Implement the 24-hour timeout rule for #underConfirmation: if a listing remains in #underConfirmation for more than 24 hours without being transitioned to #bookedViaSTYO, it must automatically revert to #available.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "- If not confirmed within 24h → revert to #available"
        ]
      },
      "acceptanceCriteria": [
        "The backend persists sufficient data to determine when a listing entered #underConfirmation (without requiring a breaking change to the Listing record schema).",
        "If a listing is in #underConfirmation and 24 hours have elapsed since it entered that status, the backend reverts it to #available.",
        "The auto-revert removes/clears any stored underConfirmation timestamp tracking for that listing.",
        "The auto-revert is applied consistently so that subsequent reads (e.g., getListing/getListings) do not continue to show an expired #underConfirmation status."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Enforce authorization rules for propertyStatus transitions so only the listing owner or an admin can advance the propertyStatus for that listing (auto-revert is system-driven).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Only implement transition logic."
        ]
      },
      "acceptanceCriteria": [
        "If the caller is neither the listing owner nor an admin, the transition method rejects with an English authorization error.",
        "If the caller is the listing owner, valid transitions succeed.",
        "If the caller is an admin, valid transitions succeed.",
        "Auto-revert does not require a caller action and is not blocked by authorization checks."
      ]
    }
  ],
  "constraints": [
    "Do NOT add payment logic yet.",
    "Do NOT generate dashboards.",
    "Only implement propertyStatus transition logic and the 24-hour underConfirmation timeout revert.",
    "Keep backend architecture as a single Motoko actor in backend/main.mo."
  ],
  "nonGoals": [
    "Owner/customer confirmation popups UI",
    "IST owner/customer dashboards",
    "Booking signal tracking fields beyond what is strictly needed to support the 24-hour underConfirmation timeout",
    "Commission deduction",
    "Listing reactivation logic beyond reverting expired underConfirmation back to #available",
    "Any Stripe/payment integration changes"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}